sndefine("split-tests",["browser","utils","preprocessor-utils","core-sleeknote","storage-instance","logger","constants"],(function(t,s,e,o,n,i,r){var a=this;function l(t){return Object.keys(t).length}function h(t,s){return Math.floor(Math.random()*(s-t+1)+t)}var c=function(t){this.options=s.extend({smart:!1,name:null,cohorts:null,sample:1,invalidConfigCallback:function(){},previousChoiceRemoved:function(){}},t);let e=this.options.name;e?this.options.cohorts?l(this.options.cohorts)<2?this.getCohort(e)?(p({msgs:["Invalid test because one of the campaigns is no longer available"],styles:["error"]}),this.options.previousChoiceRemoved()):(p({msgs:["Invalid test because only 1 campaign was included."],styles:["error"]}),p({msgs:["Campaign ",Object.keys(this.options.cohorts)[0]," was chosen"],styles:["normal","normal-bold","normal"]}),this.options.invalidConfigCallback()):(this.cohorts=Object.keys(this.options.cohorts),this.run(e)):(p({msgs:["Invalid test because it doesn't have campaigns, please, contact sleeknote support in https://help.sleeknote.com/kb-tickets/new"],styles:["error"]}),this.options.invalidConfigCallback()):(p({msgs:["Invalid test because it's missing the name, please, contact sleeknote support in https://help.sleeknote.com/kb-tickets/new"],styles:["error"]}),this.options.invalidConfigCallback())};c.prototype={run:function(t){var s,e=a.location.hash;0===e.indexOf("#")&&(e=e.slice(1,e.length));for(var o=e.split("&"),i=0;i<o.length;i++){var r=o[i].split("="),c=r[0];s=r[1],this.options.name==c&&this.setCohort(t,s)}var g,p,m,u,f=this.getInTest(t);if(null===f&&(f=Math.random()<=this.options.sample),f){if(n.setInTest(t,1),this.getCohort(t))g=this.getCohort(t);else{var d,C=0,v=l(this.options.cohorts);if(this.options.smart){for(d=h(1,100);v--;)if(s=this.options.cohorts[this.cohorts[v]],p=d,m=s.low,u=s.high,p>=m&&p<=u){C=v;break}}else C=h(0,v-1);g=this.cohorts[C],this.setCohort(t,g)}this.options.cohorts[g]&&this.options.cohorts[g].onChosen&&this.options.cohorts[g].onChosen()}else this.setInTest(t,0)},getInTest:function(t){return n.getInTest(t)},getCohort:function(t){if(this.getInTest(t))return n.getChosenCohort(t)},setCohort:function(t,s){return-1!=this.cohorts.indexOf(s)&&(n.setChosenCohort(t,s),!0)}};var g=r.PROFILE,p=i.log(r.CORE.LOGLEVELS.CS,r.CORE.FORMATTERS.SNDEBUG);return{generateFromSmarts:function(t,o){var n={},i=[];return t.forEach((function(t,r){if(t){var a,l,h,c=t.CampaignId+"-smart";if(Array.isArray(a=(h=e.getProfile(t,o))!=g.MOBILE&&h!=g.IGNORE?t.smarts:void 0)){n[c]=[];var p=1;(a=a.map((function(t){return t.low=p,t.high=p+t.weight-1,p=t.high+1,t}))).forEach((function(e,o){var n=[s.extend(e)],r=[n[0].id,n[0].type,n[0].value,n[0].weight].join(",");o?((l=s.extend(t)).SplitTestId=c,l.smartIndex=r,l.rules.triggers=n,i.push(l)):(t.smartIndex=r,t.rules.triggers=n,t.SplitTestId=c)})),t=!1}}})),{sleekNotes:t.concat(i),splitTests:n}},filterConfig:function(t,s){if(!Array.isArray(t))return[];var e=[],o=[],i="";return p({msgs:["SPLIT-TESTS:"],type:"groupCollapsed",styles:["message"]}),Object.keys(s).forEach((function(n){var a,l,h=s[n],g=h.length,m=0,u=100;if(g){p({msgs:[`${n} with ${g} campaigns`],type:"groupCollapsed",styles:["group"]});var f={};for(l=0;l<g;l++)a=t[h[l]].smartIndex||"",i=t[h[l]].campaignId,a&&(m=t[h[l]].triggers[0].low||0,u=t[h[l]].triggers[0].high||100),f[i+a]={sleeknoteId:i,smartIndex:a,low:m,high:u,onChosen:function(t){return function(){if(a){const t=a.split(","),s=t[1],e=t[2];p({msgs:["Campaign ",`${i} with trigger ${r.TRIGGERS.TYPES[s]}(${e})`," was chosen"],styles:["normal","normal-bold","normal"]})}else p({msgs:["Campaign ",i," was chosen"],styles:["normal","normal-bold","normal"]});e.push(h[t])}}(l)};try{p({msgs:["Campaigns in this test: "],styles:["normal"]}),Object.values(f).forEach((t=>{if(t.smartIndex){const s=t.smartIndex.split(","),e=s[1],o=s[2];p({msgs:[` - ${t.sleeknoteId} with trigger ${r.TRIGGERS.TYPES[e]}(${o})`],styles:["normal"]})}else p({msgs:[` - ${t.sleeknoteId}`],styles:["normal"]})})),new c({smart:a,name:a?i:n,sample:1,cohorts:f,invalidConfigCallback:function(){Object.keys(f).length<2&&(o[n]=!0)},previousChoiceRemoved:function(){}})}catch(t){p(t)}p({type:"groupEnd"})}})),p({type:"groupEnd"}),t.filter((function(t,s){if(t){if(t.splitTestId){if(o[t.splitTestId])return delete t.splitTestId,t;if(e.indexOf(s)<0)return}n.setShowCount(t.campaignId,n.getShowCount(t.campaignId))}return t}))}}}));